<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN API Tester - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-success { border-left: 4px solid #10b981; }
        .step-failed { border-left: 4px solid #ef4444; }
        .step-running { border-left: 4px solid #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-indigo-600 mb-2">BPMN API Tester</h1>
                    <p class="text-gray-600 text-lg">AI-Powered Business Process Testing | Team team112</p>
                </div>
                <div class="text-right">
                    <div class="inline-block px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold">
                        ‚úÖ Backend Online
                    </div>
                    <div id="aiStatus" class="mt-2 text-sm text-gray-600">Checking AI...</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel: Upload & Processes -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Upload Section -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        üì§ Upload Process
                    </h2>
                    <form id="uploadForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Process Name</label>
                            <input type="text" id="processName" placeholder="e.g., Bonus Payment" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">File Type</label>
                            <select id="fileType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="bpmn">BPMN (*.bpmn)</option>
                                <option value="sequence">Sequence (*.puml)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                            <input type="file" id="processFile" accept=".bpmn,.xml,.puml,.txt" required
                                   class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 cursor-pointer">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition transform hover:scale-105">
                            Upload & Parse
                        </button>
                    </form>
                    <div id="uploadResult" class="mt-4 hidden"></div>
                </div>

                <!-- Processes List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìã Processes</h2>
                        <button onclick="loadProcesses()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="processList" class="space-y-2">
                        <p class="text-gray-500 text-sm">No processes yet. Upload a file to start.</p>
                    </div>
                </div>

                <!-- Test Data Templates -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üóÇÔ∏è Test Data</h2>
                    <button onclick="showTestData()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg font-medium transition">
                        View Templates
                    </button>
                </div>
            </div>

            <!-- Right Panel: Execution & Results -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Process Details -->
                <div id="processDetails" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Process Details</h2>
                    <div id="processInfo"></div>
                    <div class="mt-6 flex gap-4">
                        <button onclick="executeTest(false)" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                            ‚ñ∂Ô∏è Run Test (Standard)
                        </button>
                        <button onclick="executeTest(true)" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                            ü§ñ Run with AI
                        </button>
                    </div>
                </div>

                <!-- Execution Results -->
                <div id="executionResults" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">‚ö° Execution Results</h2>
                        <div id="executionStatus"></div>
                    </div>
                    <div id="stepResults" class="space-y-3"></div>
                    <div id="exportButtons" class="mt-6 flex gap-3 hidden">
                        <button onclick="exportReport('html')" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                            üìÑ HTML
                        </button>
                        <button onclick="exportReport('csv')" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                            üìä CSV
                        </button>
                        <button onclick="exportReport('json')" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                            üìã JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Test Data -->
    <div id="testDataModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Test Data Templates</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="testDataContent"></div>
        </div>
    </div>

    <script>
        let currentProcessId = null;
        let currentExecutionId = null;

        // Check backend and AI status
        async function checkStatus() {
            try {
                const aiStatus = await fetch('/api/v1/ai/status').then(r => r.json());
                document.getElementById('aiStatus').innerHTML = aiStatus.enabled 
                    ? `<span class="text-green-600">ü§ñ AI: ${aiStatus.provider}</span>`
                    : '<span class="text-yellow-600">‚ö†Ô∏è AI: Fallback mode</span>';
            } catch (e) {
                document.getElementById('aiStatus').innerHTML = '<span class="text-red-600">‚ùå Backend offline</span>';
            }
        }

        // Upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileType = document.getElementById('fileType').value;
            const processFile = document.getElementById('processFile').files[0];
            const processName = document.getElementById('processName').value;
            
            const formData = new FormData();
            formData.append(fileType === 'bpmn' ? 'bpmn' : 'sequence', processFile);
            if (processName) formData.append('name', processName);
            
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg';
            resultDiv.innerHTML = '<p class="text-blue-700">‚è≥ Uploading and parsing...</p>';
            resultDiv.classList.remove('hidden');
            
            try {
                const endpoint = fileType === 'bpmn' 
                    ? '/api/v1/processes/upload' 
                    : '/api/v1/processes/upload-sequence';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg fade-in';
                    resultDiv.innerHTML = `
                        <p class="text-green-700 font-semibold">‚úÖ ${data.message}</p>
                        <p class="text-gray-600 text-sm mt-2">Process ID: ${data.id} | Steps: ${data.steps}</p>
                    `;
                    loadProcesses();
                    setTimeout(() => showProcessDetails(data.id), 1000);
                } else {
                    resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                    resultDiv.innerHTML = `<p class="text-red-700">‚ùå Error: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                resultDiv.innerHTML = `<p class="text-red-700">‚ùå Error: ${error.message}</p>`;
            }
        });

        // Load processes
        async function loadProcesses() {
            const listDiv = document.getElementById('processList');
            listDiv.innerHTML = '<p class="text-gray-500 text-sm">Loading...</p>';
            
            try {
                const processes = await fetch('/api/v1/processes').then(r => r.json());
                
                if (processes.length === 0) {
                    listDiv.innerHTML = '<p class="text-gray-500 text-sm">No processes yet.</p>';
                    return;
                }
                
                listDiv.innerHTML = processes.map(p => `
                    <div onclick="showProcessDetails(${p.id})" 
                         class="p-3 bg-gray-50 hover:bg-indigo-50 rounded-lg cursor-pointer transition border border-gray-200 hover:border-indigo-300">
                        <div class="font-semibold text-gray-800">${p.name}</div>
                        <div class="text-xs text-gray-500 mt-1">${p.steps} steps ‚Ä¢ ${new Date(p.createdAt).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (error) {
                listDiv.innerHTML = `<p class="text-red-500 text-sm">Error: ${error.message}</p>`;
            }
        }

        // Show process details
        async function showProcessDetails(id) {
            currentProcessId = id;
            const detailsDiv = document.getElementById('processDetails');
            const infoDiv = document.getElementById('processInfo');
            
            try {
                const process = await fetch(`/api/v1/processes/${id}`).then(r => r.json());
                
                infoDiv.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${process.name}</h3>
                        <p class="text-sm text-gray-600">${process.description}</p>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-semibold text-gray-700">Steps:</h4>
                        ${process.steps.map((s, i) => `
                            <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">
                                    ${i + 1}
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${s.name}</div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        ${s.method ? `<span class="font-mono bg-gray-200 px-2 py-0.5 rounded">${s.method}</span>` : ''}
                                        ${s.endpoint || 'No endpoint'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                detailsDiv.classList.remove('hidden');
                detailsDiv.classList.add('fade-in');
                detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                alert('Error loading process: ' + error.message);
            }
        }

        // Execute test
        async function executeTest(useAI) {
            if (!currentProcessId) return;
            
            const resultsDiv = document.getElementById('executionResults');
            const statusDiv = document.getElementById('executionStatus');
            const stepsDiv = document.getElementById('stepResults');
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.classList.add('fade-in');
            statusDiv.innerHTML = '<span class="text-blue-600 font-semibold">‚è≥ Running...</span>';
            stepsDiv.innerHTML = '<p class="text-gray-500">Executing steps...</p>';
            
            try {
                const response = await fetch(`/api/v1/processes/${currentProcessId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'STANDARD',
                        generateTestData: useAI,
                        initialContext: {}
                    })
                });
                
                const execution = await response.json();
                currentExecutionId = execution.executionId;
                
                const statusColor = execution.status === 'COMPLETED' ? 'text-green-600' : 'text-red-600';
                statusDiv.innerHTML = `<span class="${statusColor} font-semibold">${execution.status === 'COMPLETED' ? '‚úÖ' : '‚ùå'} ${execution.status}</span>`;
                
                stepsDiv.innerHTML = execution.stepResults.map(r => `
                    <div class="step-${r.status.toLowerCase()} bg-gray-50 rounded-lg p-4 fade-in">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-800">${r.stepName}</span>
                            <span class="text-sm ${r.status === 'SUCCESS' ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${r.status} ${r.httpStatus ? `(${r.httpStatus})` : ''}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 font-mono">${r.endpoint || 'No endpoint'}</div>
                        <div class="text-xs text-gray-500 mt-2">‚è±Ô∏è ${r.executionTimeMs}ms</div>
                        ${r.errorMessage ? `<div class="mt-2 text-sm text-red-600">‚ùå ${r.errorMessage}</div>` : ''}
                    </div>
                `).join('');
                
                document.getElementById('exportButtons').classList.remove('hidden');
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-600 font-semibold">‚ùå ERROR</span>';
                stepsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        // Export report
        async function exportReport(format) {
            if (!currentExecutionId) return;
            
            const url = `/api/v1/executions/${currentExecutionId}/export/${format}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `report-${currentExecutionId}.${format}`;
            link.click();
        }

        // Show test data
        async function showTestData() {
            try {
                const templates = await fetch('/api/v1/test-data/templates').then(r => r.json());
                const content = document.getElementById('testDataContent');
                
                content.innerHTML = Object.entries(templates).map(([name, data]) => `
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">${name}</h4>
                        <pre class="text-xs bg-gray-800 text-green-400 p-3 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `).join('');
                
                document.getElementById('testDataModal').classList.remove('hidden');
            } catch (e) {
                alert('Error loading test data: ' + e.message);
            }
        }

        function closeModal() {
            document.getElementById('testDataModal').classList.add('hidden');
        }

        // Initialize
        checkStatus();
        loadProcesses();
    </script>
</body>
</html>